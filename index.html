<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Coin Flip Dare</title>
    <meta name="theme-color" content="#121212">
    <meta name="description" content="Multiplayer Coin Flip with Dares">

    <style>
        /* --- Reset & Variables --- */
        :root {
            --bg: #121212;
            --surface: #1e1e1e;
            --surface-light: #2c2c2c;
            --primary: #bb86fc;
            --secondary: #03dac6;
            --error: #cf6679;
            --text: #e0e0e0;
            --text-dim: #a0a0a0;
            --radius: 16px;
            --coin-size: 150px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 0;
            background-color: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- Screens --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            transition: transform 0.3s ease, opacity 0.3s ease;
            background: var(--bg); z-index: 10;
        }
        .screen.hidden { transform: translateY(100%); opacity: 0; pointer-events: none; z-index: 0; }
        .screen.active { transform: translateY(0); opacity: 1; z-index: 20; }

        /* --- Start Screen --- */
        #startScreen { justify-content: center; align-items: center; padding: 20px; }
        .start-card {
            background: var(--surface); padding: 40px 30px;
            border-radius: 24px; width: 100%; max-width: 380px;
            text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .start-title {
            font-size: 2rem; font-weight: 900; color: var(--primary);
            margin-bottom: 30px; letter-spacing: 1px; text-transform: uppercase;
        }
        .input-lg {
            width: 100%; padding: 16px; background: var(--bg);
            border: 2px solid var(--surface-light); border-radius: 12px;
            color: white; font-size: 1.2rem; text-align: center; margin-bottom: 20px;
        }
        .input-lg:focus { border-color: var(--primary); outline: none; }
        
        /* --- Game Layout --- */
        header { padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-weight: 800; font-size: 1.1rem; letter-spacing: 0.5px; }
        
        .main-scroll {
            flex: 1; overflow-y: auto; padding: 10px; padding-bottom: 120px;
            max-width: 600px; margin: 0 auto; width: 100%;
        }

        .panel {
            background: var(--surface); border-radius: var(--radius);
            padding: 16px; margin-bottom: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        /* --- Player Chips & Info --- */
        .info-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .room-badge { 
            display: flex; align-items: center; gap: 8px; background: var(--surface-light);
            padding: 4px 8px 4px 12px; border-radius: 20px; font-family: monospace; font-size: 1rem; color: var(--secondary);
        }
        .copy-btn {
            background: none; border: none; color: white; cursor: pointer; padding: 4px; display: flex;
        }
        
        .player-grid { display: flex; flex-wrap: wrap; gap: 6px; }
        .p-chip {
            font-size: 0.8rem; padding: 5px 10px; border-radius: 10px; background: var(--surface-light);
            border: 1px solid transparent; opacity: 0.7; transition: all 0.3s;
        }
        .p-chip.active { opacity: 1; border-color: var(--primary); background: rgba(187, 134, 252, 0.15); font-weight: bold; }
        .p-chip.me { color: var(--secondary); }

        /* --- Coin --- */
        .coin-stage {
            height: 220px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; position: relative;
        }
        .coin-scene { width: var(--coin-size); height: var(--coin-size); perspective: 1000px; }
        .coin-obj {
            width: 100%; height: 100%; position: relative; transform-style: preserve-3d;
        }
        .face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 3rem; font-weight: 900; border: 4px solid #DAA520;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.6);
        }
        .face.front { background: radial-gradient(circle at 30% 30%, #ffd700, #b8860b); color: #5a4a00; transform: rotateY(0deg); }
        .face.back { background: radial-gradient(circle at 30% 30%, #e0e0e0, #909090); color: #333; transform: rotateY(180deg); border-color: #a0a0a0; }

        .result-text {
            font-size: 1.5rem; font-weight: 800; letter-spacing: 3px; min-height: 1.5em;
            margin-top: 20px; text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .turn-text { font-size: 0.9rem; color: var(--text-dim); margin-top: 4px; font-weight: 500; }
        .turn-text.my-turn { color: var(--primary); animation: pulseText 2s infinite; }

        /* --- Controls --- */
        .pred-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .btn-opt {
            padding: 14px; background: var(--surface-light); border: 2px solid transparent;
            color: var(--text); border-radius: 12px; font-weight: 700; cursor: pointer; transition: all 0.2s;
        }
        .btn-opt.selected { border-color: var(--secondary); background: rgba(3, 218, 198, 0.1); color: var(--secondary); }
        
        .dare-panel { flex: 1; display: flex; flex-direction: column; min-height: 120px; }
        .dare-input-row { display: flex; gap: 8px; margin-top: auto; }
        .inp-dare {
            flex: 1; background: var(--bg); border: 1px solid var(--surface-light);
            border-radius: 8px; padding: 10px; color: white;
        }
        .btn-send {
            background: var(--secondary); color: black; border: none; font-weight: 800;
            padding: 0 16px; border-radius: 8px; cursor: pointer;
        }
        .btn-send:disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- Bottom Bar --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--surface); padding: 12px;
            display: grid; grid-template-columns: auto auto 1fr; gap: 8px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.4); max-width: 600px; left: 50%; transform: translateX(-50%);
        }
        .nav-btn {
            height: 50px; border-radius: 10px; border: none; font-weight: 700;
            cursor: pointer; padding: 0 16px; font-size: 0.9rem;
        }
        .btn-act { background: var(--surface-light); color: var(--text); }
        .btn-flip { background: var(--primary); color: #000; font-size: 1.1rem; }
        .btn-flip:disabled { opacity: 0.4; cursor: not-allowed; background: var(--surface-light); color: var(--text-dim); }

        /* --- Overlays --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s; padding: 40px; text-align: center;
        }
        .overlay.visible { opacity: 1; pointer-events: auto; }
        .dare-big-title { color: var(--error); font-size: 1.2rem; font-weight: 900; letter-spacing: 4px; margin-bottom: 20px; }
        .dare-big-text { font-size: 1.8rem; font-weight: 700; line-height: 1.4; margin-bottom: 30px; }
        .btn-done {
            background: white; color: black; border: none; padding: 15px 40px;
            border-radius: 50px; font-weight: 900; font-size: 1.1rem; cursor: pointer;
            transform: scale(1); animation: pulseBtn 2s infinite;
        }

        .toast-box {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; gap: 10px; z-index: 200; width: 90%; max-width: 350px; pointer-events: none;
        }
        .toast {
            background: var(--surface); color: white; padding: 12px 16px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); text-align: center; font-size: 0.9rem;
            animation: slideDown 0.3s ease-out; border-left: 4px solid var(--text-dim);
        }
        .toast.success { border-color: var(--secondary); }
        .toast.error { border-color: var(--error); }

        @keyframes pulseText { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        @keyframes pulseBtn { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; } }
    </style>
</head>
<body>

    <!-- --- START SCREEN --- -->
    <div id="screenStart" class="screen active">
        <div id="startScreen">
            <div class="start-card">
                <div class="start-title">Coin Flip Dare</div>
                <input type="text" id="inpName" class="input-lg" placeholder="Enter Your Nickname" maxlength="12">
                <button id="btnEnter" class="nav-btn btn-flip" style="width:100%">ENTER ROOM</button>
            </div>
        </div>
    </div>

    <!-- --- GAME SCREEN --- -->
    <div id="screenGame" class="screen hidden">
        <header>
            <div class="logo">COIN FLIP DARE</div>
            <div id="statusDot" style="width:10px; height:10px; border-radius:50%; background:var(--error);"></div>
        </header>

        <div class="main-scroll">
            <!-- Room & Players -->
            <div class="panel">
                <div class="info-row">
                    <div class="room-badge">
                        CODE: <span id="dispCode">----</span>
                        <button class="copy-btn" id="btnCopyLink" title="Copy Link">
                            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                        </button>
                    </div>
                    <div style="font-size:0.9rem; color:var(--text-dim);">Players: <span id="dispCount">0</span></div>
                </div>
                <div class="player-grid" id="listPlayers"></div>
            </div>

            <!-- Coin -->
            <div class="coin-stage">
                <div class="coin-scene">
                    <div class="coin-obj" id="elCoin">
                        <div class="face front">H</div>
                        <div class="face back">T</div>
                    </div>
                </div>
                <div class="result-text" id="dispResult">WAITING...</div>
                <div class="turn-text" id="dispTurn">Loading game data...</div>
            </div>

            <!-- Predictions -->
            <div class="panel">
                <div class="info-row" style="margin-bottom:8px">
                    <span style="font-weight:700; font-size:0.8rem; color:var(--text-dim);">PREDICTION</span>
                </div>
                <div class="pred-grid">
                    <button class="btn-opt" id="btnPredH">HEADS</button>
                    <button class="btn-opt" id="btnPredT">TAILS</button>
                </div>
            </div>

            <!-- Dare Chat -->
            <div class="panel dare-panel">
                <div class="info-row">
                    <span style="font-weight:700; font-size:0.8rem; color:var(--text-dim);">DARE CHAT</span>
                    <span id="dispEligible" style="font-size:0.7rem; color:var(--text-dim);">Winners can dare</span>
                </div>
                <div class="dare-input-row">
                    <input type="text" id="inpDare" class="inp-dare" placeholder="Enter a dare..." disabled>
                    <button id="btnSendDare" class="btn-send" disabled>SEND</button>
                </div>
            </div>
        </div>

        <div class="bottom-nav">
            <button class="nav-btn btn-act" id="btnReset">RESET</button>
            <button class="nav-btn btn-act" id="btnCopyBtm">LINK</button>
            <button class="nav-btn btn-flip" id="btnFlip" disabled>FLIP COIN</button>
        </div>
    </div>

    <!-- --- OVERLAY --- -->
    <div id="overlayDare" class="overlay">
        <div class="dare-big-title">ACTIVE DARE</div>
        <div class="dare-big-text" id="overlayText">...</div>
        <div style="color:#aaa; margin-bottom:30px;">From: <span id="overlayFrom"></span></div>
        <button class="btn-done" id="btnDoneDare">MARK COMPLETED</button>
    </div>

    <div class="toast-box" id="toastBox"></div>

    <script type="module">
        // --- Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, runTransaction, serverTimestamp, onDisconnect, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAwlWUvMOBfz2pTh18MqpDsVk3Hl-xPmJQ",
            authDomain: "coinflip-97336.firebaseapp.com",
            databaseURL: "https://coinflip-97336-default-rtdb.firebaseio.com",
            projectId: "coinflip-97336",
            storageBucket: "coinflip-97336.firebasestorage.app",
            messagingSenderId: "1026597403544",
            appId: "1:1026597403544:web:f204ff9806ca73b7ecc9ed",
            measurementId: "G-D45WX8RGCW"
        };

        // --- Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- State ---
        let currentUser = null;
        let myName = "";
        let currentRoomId = null;
        
        // Game State
        let gameState = {
            count: 0,
            flipperId: null,
            players: [],
            lastResult: null
        };
        
        let localState = {
            coinRotation: 0,
            isFlipping: false,
            myPrediction: null
        };

        // --- UI Refs ---
        const ui = {
            screens: { start: document.getElementById('screenStart'), game: document.getElementById('screenGame') },
            inputs: { name: document.getElementById('inpName'), dare: document.getElementById('inpDare') },
            btns: { 
                enter: document.getElementById('btnEnter'), 
                flip: document.getElementById('btnFlip'),
                reset: document.getElementById('btnReset'),
                copy1: document.getElementById('btnCopyLink'),
                copy2: document.getElementById('btnCopyBtm'),
                predH: document.getElementById('btnPredH'),
                predT: document.getElementById('btnPredT'),
                sendDare: document.getElementById('btnSendDare'),
                doneDare: document.getElementById('btnDoneDare')
            },
            disp: {
                code: document.getElementById('dispCode'),
                list: document.getElementById('listPlayers'),
                count: document.getElementById('dispCount'),
                coin: document.getElementById('elCoin'),
                result: document.getElementById('dispResult'),
                turn: document.getElementById('dispTurn'),
                elig: document.getElementById('dispEligible'),
                dot: document.getElementById('statusDot')
            },
            overlay: {
                el: document.getElementById('overlayDare'),
                text: document.getElementById('overlayText'),
                from: document.getElementById('overlayFrom')
            }
        };

        // --- Initialization ---
        function init() {
            try {
                // Restore Name
                const saved = localStorage.getItem('cf_name');
                if(saved) ui.inputs.name.value = saved;

                // Setup Listeners
                ui.btns.enter.addEventListener('click', handleEnter);
                ui.btns.flip.addEventListener('click', handleFlip);
                ui.btns.reset.addEventListener('click', handleReset);
                ui.btns.copy1.addEventListener('click', copyLink);
                ui.btns.copy2.addEventListener('click', copyLink);
                ui.btns.predH.addEventListener('click', () => makePred('HEADS'));
                ui.btns.predT.addEventListener('click', () => makePred('TAILS'));
                ui.btns.sendDare.addEventListener('click', handleSendDare);
                ui.btns.doneDare.addEventListener('click', handleDoneDare);

            } catch (e) {
                toast("Init Error: " + e.message, "error");
            }
        }

        // --- Auth & Room Entry ---
        async function handleEnter() {
            const name = ui.inputs.name.value.trim();
            if(!name) return toast("Please enter a name", "error");
            
            myName = name;
            localStorage.setItem('cf_name', name);
            ui.btns.enter.disabled = true;
            ui.btns.enter.innerText = "CONNECTING...";

            try {
                await signInAnonymously(auth);
            } catch (e) {
                ui.btns.enter.disabled = false;
                ui.btns.enter.innerText = "ENTER ROOM";
                return toast("Login Failed: " + e.message, "error");
            }
        }

        // Auth Listener - Triggers Game Load
        onAuthStateChanged(auth, user => {
            if(user && myName) {
                currentUser = user;
                // Switch Screens
                ui.screens.start.classList.remove('active');
                ui.screens.start.classList.add('hidden');
                ui.screens.game.classList.remove('hidden');
                ui.screens.game.classList.add('active');
                
                setupConnectionStatus();
                handleRoomLogic();
            }
        });

        function setupConnectionStatus() {
            onValue(ref(db, ".info/connected"), snap => {
                ui.disp.dot.style.background = snap.val() ? "var(--secondary)" : "var(--error)";
            });
        }

        async function handleRoomLogic() {
            const url = new URL(window.location.href);
            let code = url.searchParams.get("room");

            if(!code) {
                // Generate Code
                const arr = new Uint8Array(3); crypto.getRandomValues(arr);
                code = Array.from(arr).map(b => b.toString(16).padStart(2,'0')).join('').toUpperCase();
                url.searchParams.set("room", code);
                window.history.replaceState({}, '', url);
            }

            currentRoomId = code;
            ui.disp.code.innerText = code;
            
            // Join Presence
            const meRef = ref(db, `rooms/${code}/players/${currentUser.uid}`);
            set(meRef, { 
                nick: myName, 
                joinedAt: serverTimestamp(),
                uid: currentUser.uid // Store UID for easier sorting later
            });
            onDisconnect(meRef).remove();

            startSync(code);
        }

        // --- Sync Logic ---
        function startSync(rid) {
            // 1. Players & Turns
            onValue(ref(db, `rooms/${rid}/players`), snap => {
                const val = snap.val() || {};
                // Deterministic Sort: JoinedAt -> UID
                const arr = Object.values(val).sort((a,b) => {
                    const tA = a.joinedAt || 0, tB = b.joinedAt || 0;
                    if(tA !== tB) return tA - tB;
                    return (a.uid > b.uid) ? 1 : -1;
                });
                
                gameState.players = arr;
                ui.disp.count.innerText = arr.length;
                renderPlayers();
                updateTurnState();
            });

            // 2. Flip Count (Round)
            onValue(ref(db, `rooms/${rid}/flipCount`), snap => {
                const c = snap.val() || 0;
                gameState.count = c;
                
                // Reset local prediction for new round
                localState.myPrediction = null;
                ui.btns.predH.classList.remove('selected');
                ui.btns.predT.classList.remove('selected');
                
                updateTurnState();
            });

            // 3. Flip Result
            onValue(ref(db, `rooms/${rid}/flip`), snap => {
                const data = snap.val();
                if(!data) {
                    // Reset
                    ui.disp.result.innerText = "WAITING...";
                    ui.disp.coin.style.transform = `rotateY(0deg)`;
                    localState.coinRotation = 0;
                    gameState.lastResult = null;
                    return;
                }

                const isNew = (!gameState.lastResult || gameState.lastResult.id !== data.id);
                gameState.lastResult = data;
                
                // Animate if new, Snap if stale (>4s old)
                const age = Date.now() - (data.ts || 0);
                const shouldAnimate = isNew && (age < 4000);
                
                performCoinVisuals(data.result, shouldAnimate);
            });

            // 4. Active Dare
            onValue(ref(db, `rooms/${rid}/activeDare`), snap => {
                const d = snap.val();
                if(d) {
                    ui.overlay.text.innerText = d.text;
                    ui.overlay.from.innerText = d.fromNick;
                    ui.overlay.el.classList.add('visible');
                } else {
                    ui.overlay.el.classList.remove('visible');
                }
            });
        }

        // --- Renderers ---
        function renderPlayers() {
            ui.disp.list.innerHTML = "";
            gameState.players.forEach(p => {
                const el = document.createElement('div');
                el.className = "p-chip";
                if(p.uid === currentUser.uid) el.classList.add('me');
                if(p.uid === gameState.flipperId) el.classList.add('active');
                
                el.innerText = (p.uid === gameState.flipperId ? "ðŸ‘‘ " : "") + p.nick;
                ui.disp.list.appendChild(el);
            });
        }

        function updateTurnState() {
            if(gameState.players.length === 0) return;
            
            // Turn Logic: (RoundCount) % (PlayerCount)
            // Round 0 = Player 0. Round 1 = Player 1.
            const idx = gameState.count % gameState.players.length;
            const flipper = gameState.players[idx];
            gameState.flipperId = flipper.uid;
            
            renderPlayers(); // Update crown highlight

            const isMe = (flipper.uid === currentUser.uid);
            
            if(isMe) {
                ui.disp.turn.innerText = "IT'S YOUR TURN!";
                ui.disp.turn.className = "turn-text my-turn";
            } else {
                ui.disp.turn.innerText = `Waiting for ${flipper.nick}...`;
                ui.disp.turn.className = "turn-text";
            }

            checkFlipEligibility(isMe);
        }

        function checkFlipEligibility(isMyTurn) {
            // Button is enabled IF:
            // 1. It is my turn
            // 2. I have predicted
            // 3. Not currently animating
            const canFlip = isMyTurn && localState.myPrediction && !localState.isFlipping;
            
            ui.btns.flip.disabled = !canFlip;
            
            if(!isMyTurn) ui.btns.flip.innerText = "WAITING...";
            else if(!localState.myPrediction) ui.btns.flip.innerText = "SELECT HEADS/TAILS";
            else ui.btns.flip.innerText = "FLIP COIN";
        }

        // --- Actions ---

        function makePred(side) {
            if(!currentRoomId) return;
            // Optimistic UI
            localState.myPrediction = side;
            ui.btns.predH.classList.toggle('selected', side === 'HEADS');
            ui.btns.predT.classList.toggle('selected', side === 'TAILS');
            
            // DB Update
            const round = gameState.count + 1; // Predicting for NEXT result
            const updates = {};
            updates[`rooms/${currentRoomId}/predictions/${round}/${currentUser.uid}`] = side;
            update(ref(db), updates);
            
            // Re-eval flip button
            updateTurnState();
        }

        function handleFlip() {
            if(ui.btns.flip.disabled) return;

            // Lock & Flip Transaction
            const lockRef = ref(db, `rooms/${currentRoomId}/lock`);
            runTransaction(lockRef, (lock) => {
                const now = Date.now();
                if(lock && lock.expires > now && lock.uid !== currentUser.uid) return; // Locked
                return { uid: currentUser.uid, expires: now + 5000 };
            }).then(res => {
                if(res.committed) {
                    executeFlipResult();
                } else {
                    toast("Someone else is flipping", "error");
                }
            });
        }

        function executeFlipResult() {
            // Generate
            const arr = new Uint8Array(1); crypto.getRandomValues(arr);
            const res = (arr[0] % 2 === 0) ? "HEADS" : "TAILS";
            const nextCount = gameState.count + 1;
            
            const updates = {};
            updates[`rooms/${currentRoomId}/flip`] = {
                id: `${nextCount}-${Date.now()}`,
                result: res,
                ts: serverTimestamp()
            };
            updates[`rooms/${currentRoomId}/flipCount`] = nextCount;
            updates[`rooms/${currentRoomId}/lock`] = null; // Release
            
            update(ref(db), updates);
        }

        // --- Visuals ---
        function performCoinVisuals(res, animate) {
            const targetDeg = (res === "HEADS") ? 0 : 180;
            
            if(animate) {
                localState.isFlipping = true;
                updateTurnState(); // Disable button
                
                // Sound
                playSound();

                // Calculate spin: Add 5 full rotations (1800deg) + difference
                const minSpins = 1800;
                const currentMod = localState.coinRotation % 360;
                const dist = minSpins + (targetDeg - currentMod);
                localState.coinRotation += dist;

                ui.disp.coin.style.transition = "transform 3s cubic-bezier(0.2, 0.8, 0.2, 1.1)";
                ui.disp.coin.style.transform = `rotateY(${localState.coinRotation}deg)`;
                
                setTimeout(() => {
                    localState.isFlipping = false;
                    finishVisuals(res);
                    updateTurnState(); // Re-enable if needed (though turn passes)
                }, 3000);
            } else {
                // Instant
                localState.coinRotation = targetDeg;
                ui.disp.coin.style.transition = "none";
                ui.disp.coin.style.transform = `rotateY(${targetDeg}deg)`;
                finishVisuals(res);
            }
        }

        function finishVisuals(res) {
            ui.disp.result.innerText = res;
            
            // Check Win/Loss for Dare Input
            const round = gameState.count; // Current count reflects the completed flip
            get(ref(db, `rooms/${currentRoomId}/predictions/${round}/${currentUser.uid}`)).then(snap => {
                const pred = snap.val();
                const won = (pred === res);
                
                ui.inputs.dare.disabled = !won;
                ui.btns.sendDare.disabled = !won;
                
                if(won) {
                    ui.inputs.dare.placeholder = "YOU WON! Write a dare...";
                    ui.disp.elig.innerText = "YOU WON! SEND A DARE";
                    ui.disp.elig.style.color = "var(--secondary)";
                } else {
                    ui.inputs.dare.placeholder = "Only winners can dare";
                    ui.disp.elig.innerText = "Only winners can dare";
                    ui.disp.elig.style.color = "var(--text-dim)";
                }
            });
        }

        // --- Dares ---
        function handleSendDare() {
            const text = ui.inputs.dare.value.trim();
            if(!text) return;
            
            set(ref(db, `rooms/${currentRoomId}/activeDare`), {
                text: text,
                fromNick: myName
            });
            ui.inputs.dare.value = "";
        }

        function handleDoneDare() {
            set(ref(db, `rooms/${currentRoomId}/activeDare`), null);
        }

        // --- Utilities ---
        function handleReset() {
            if(confirm("Reset entire room?")) {
                const u = {};
                u[`rooms/${currentRoomId}/flip`] = null;
                u[`rooms/${currentRoomId}/flipCount`] = 0;
                u[`rooms/${currentRoomId}/activeDare`] = null;
                u[`rooms/${currentRoomId}/predictions`] = null;
                update(ref(db), u);
            }
        }

        function copyLink() {
            const url = new URL(window.location.href);
            url.searchParams.set("room", currentRoomId);
            const str = url.toString();
            
            // Robust Fallback
            if(navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(str).then(() => toast("Link Copied", "success"))
                .catch(() => fallbackCopy(str));
            } else {
                fallbackCopy(str);
            }
        }

        function fallbackCopy(str) {
            const el = document.createElement('textarea');
            el.value = str;
            document.body.appendChild(el);
            el.select();
            try {
                document.execCommand('copy');
                toast("Link Copied", "success");
            } catch (e) {
                toast("Copy failed", "error");
            }
            document.body.removeChild(el);
        }

        function playSound() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(600, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(1200, ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                osc.start(); osc.stop(ctx.currentTime + 0.2);
            } catch(e) {}
        }

        function toast(msg, type) {
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            el.innerText = msg;
            document.getElementById('toastBox').appendChild(el);
            setTimeout(() => {
                el.style.animation = "fadeOut 0.3s forwards";
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        // --- Run ---
        init();

    </script>
</body>
</html>


