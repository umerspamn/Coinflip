<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Coin Flip Dare</title>
    <meta name="theme-color" content="#121212">
    <meta name="description" content="Multiplayer Coin Flip with Dares">

    <style>
        /* --- Reset & Base --- */
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --surface-highlight: #2c2c2c;
            --primary-color: #bb86fc;
            --secondary-color: #03dac6;
            --error-color: #cf6679;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --radius-lg: 20px;
            --radius-md: 12px;
            --spacing-unit: 8px;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            --font-mono: "SF Mono", "Monaco", "Inconsolata", "Fira Mono", "Droid Sans Mono", "Source Code Pro", monospace;
            --coin-size: 160px;
            --coin-thickness: 10px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Layout --- */
        .app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: var(--spacing-unit);
            overflow-y: auto;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            padding-bottom: 140px; /* Space for bottom bar */
        }

        /* --- Header --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 4px;
        }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 700; letter-spacing: 0.5px; }
        .status-pill {
            font-size: 0.75rem;
            font-weight: 700;
            background: var(--surface-color);
            padding: 4px 10px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: var(--error-color); }
        .status-pill.connected .status-dot { background-color: var(--secondary-color); }

        /* --- Panels --- */
        .panel {
            background: var(--surface-color);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        /* --- Info Panel --- */
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.9rem;
        }
        .info-label { color: var(--text-muted); font-size: 0.75rem; display: block; margin-bottom: 2px; }
        .info-value { font-family: var(--font-mono); font-weight: 600; color: var(--secondary-color); }
        
        .code-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .icon-btn {
            background: rgba(3, 218, 198, 0.15);
            border: 1px solid rgba(3, 218, 198, 0.3);
            color: var(--secondary-color);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s;
            padding: 0;
            -webkit-appearance: none;
        }
        .icon-btn:active { background: rgba(3, 218, 198, 0.4); transform: scale(0.95); }
        .icon-btn svg { width: 16px; height: 16px; }

        .player-list {
            grid-column: span 2;
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .player-chip {
            background: var(--surface-highlight);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-family: var(--font-mono);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .player-chip.online { border: 1px solid var(--secondary-color); }
        
        /* --- Coin Section --- */
        .coin-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 0;
            position: relative;
            min-height: 250px;
        }
        .coin-container {
            width: var(--coin-size);
            height: var(--coin-size);
            perspective: 1000px;
            margin-bottom: 20px;
        }
        .coin {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            /* Transition set dynamically via JS */
        }
        .coin-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: bold;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5), 0 5px 15px rgba(0,0,0,0.4);
            background: radial-gradient(circle at 30% 30%, #ffd700, #b8860b);
            color: #4a3b00;
            border: 4px solid #DAA520;
        }
        .coin-face.tails { transform: rotateY(180deg); background: radial-gradient(circle at 30% 30%, #c0c0c0, #808080); color: #333; border-color: #A9A9A9; }
        .coin-face::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; height: 80%;
            border-radius: 50%;
            border: 2px dashed rgba(0,0,0,0.2);
        }

        .result-display {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: 2px;
            min-height: 1.5em;
            text-align: center;
            color: var(--text-main);
            transition: color 0.3s, text-shadow 0.3s;
        }
        .result-display.glow {
            color: var(--secondary-color);
            text-shadow: 0 0 10px var(--secondary-color);
        }
        .flipping-overlay {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 900;
            font-size: 1.5rem;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            z-index: 10;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .flipping-overlay.visible { opacity: 1; }

        /* --- Predictions Panel --- */
        .prediction-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        .pred-btn {
            background: var(--surface-highlight);
            border: 2px solid transparent;
            color: var(--text-main);
            padding: 14px;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .pred-btn.selected {
            background: rgba(3, 218, 198, 0.15);
            border-color: var(--secondary-color);
            color: var(--secondary-color);
        }
        .pred-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-muted);
            font-family: var(--font-mono);
        }

        /* --- Dare Panel --- */
        .dare-header {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dare-status { font-size: 0.75rem; color: var(--text-muted); }
        .dare-status.success { color: var(--secondary-color); }
        .dare-list {
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .dare-item {
            background: var(--surface-highlight);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .dare-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 2px;
            font-family: var(--font-mono);
        }
        .dare-input-group { display: flex; gap: 8px; }
        .dare-input {
            flex: 1;
            background: var(--bg-color);
            border: 1px solid var(--surface-highlight);
            border-radius: 8px;
            padding: 10px;
            color: white;
            font-family: inherit;
        }
        .dare-send-btn {
            background: var(--secondary-color);
            color: #000;
            border: none;
            border-radius: 8px;
            padding: 0 16px;
            font-weight: 700;
            cursor: pointer;
        }
        .dare-send-btn:disabled { background: var(--surface-highlight); color: var(--text-muted); cursor: not-allowed; }

        /* --- Bottom Bar --- */
        .bottom-bar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: var(--surface-color);
            padding: 12px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 10px;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.3);
            z-index: 100;
            max-width: 600px;
            margin: 0 auto;
        }
        .action-btn {
            height: 52px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .action-btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary-color); color: #000; }
        .btn-secondary { background: var(--surface-highlight); color: var(--text-main); }
        .btn-danger { background: rgba(207, 102, 121, 0.2); color: var(--error-color); }

        /* --- Room Modal --- */
        .modal-backdrop {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        .modal-backdrop.open { opacity: 1; pointer-events: auto; }
        .bottom-sheet {
            background: var(--surface-color);
            width: 100%;
            max-width: 600px;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            padding: 24px;
            transform: translateY(100%);
            transition: transform 0.2s ease-out;
        }
        .modal-backdrop.open .bottom-sheet { transform: translateY(0); }
        .sheet-title { margin-top: 0; margin-bottom: 16px; }
        .sheet-input {
            width: 100%;
            padding: 14px;
            background: var(--bg-color);
            border: 1px solid var(--surface-highlight);
            border-radius: var(--radius-md);
            color: white;
            font-family: var(--font-mono);
            font-size: 1.2rem;
            text-transform: uppercase;
            text-align: center;
            margin-bottom: 16px;
        }
        .sheet-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* --- Toasts --- */
        .toast-container {
            position: fixed;
            top: 16px; left: 50%;
            transform: translateX(-50%);
            z-index: 300;
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 90%;
            max-width: 350px;
            pointer-events: none;
        }
        .toast {
            background: var(--surface-color);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-size: 0.9rem;
            text-align: center;
            border-left: 4px solid var(--text-muted);
            opacity: 0;
            transform: translateY(-10px);
            animation: toastIn 0.3s forwards;
        }
        .toast.success { border-color: var(--secondary-color); }
        .toast.error { border-color: var(--error-color); }
        .toast.warn { border-color: #ffb74d; }

        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes toastIn { to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { to { opacity: 0; } }

        @media (prefers-reduced-motion: reduce) {
            .coin, .action-btn, .dare-item, .toast, .bottom-sheet {
                transition: none !important;
                animation: none !important;
            }
        }
    </style>
</head>
<body>

    <header style="max-width: 600px; margin: 0 auto; width: 100%; padding: 12px 16px;">
        <h1>Coin Flip Dare</h1>
        <div id="connStatus" class="status-pill">
            <div class="status-dot"></div>
            <span id="connText">OFFLINE</span>
        </div>
    </header>

    <div class="app-container">
        
        <div class="panel">
            <div class="info-grid">
                <div>
                    <span class="info-label">ROOM CODE</span>
                    <div class="code-wrapper">
                        <span id="roomCodeDisplay" class="info-value">----</span>
                        <button class="icon-btn" onclick="copyInviteLink()" title="Copy Invite Link" aria-label="Copy Invite Link">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div style="text-align: right;">
                    <span class="info-label">YOUR NICK</span>
                    <span id="myNickDisplay" class="info-value">...</span>
                </div>
                <div class="player-list" id="playerList">
                    </div>
            </div>
        </div>

        <div class="coin-section">
            <div class="flipping-overlay" id="flipOverlay">FLIPPING...</div>
            <div class="coin-container">
                <div class="coin" id="coin">
                    <div class="coin-face">H</div>
                    <div class="coin-face tails">T</div>
                </div>
            </div>
            <div id="resultText" class="result-display" aria-live="polite">WAITING...</div>
        </div>

        <div class="panel">
            <div class="dare-header">
                <span>PREDICTION (Round #<span id="roundNum">0</span>)</span>
            </div>
            <div class="prediction-buttons">
                <button class="pred-btn" id="btnPredHeads" onclick="setPrediction('HEADS')">HEADS</button>
                <button class="pred-btn" id="btnPredTails" onclick="setPrediction('TAILS')">TAILS</button>
            </div>
            <div class="pred-stats">
                <span>You: <span id="myPrediction">NONE</span></span>
                <span>H: <span id="countHeads">0</span> | T: <span id="countTails">0</span></span>
            </div>
        </div>

        <div class="panel" style="flex: 1; min-height: 200px; display: flex; flex-direction: column;">
            <div class="dare-header">
                <span>DARES</span>
                <span id="dareEligibility" class="dare-status">Predict to dare</span>
            </div>
            <div class="dare-list" id="dareList">
                <div style="color: var(--text-muted); font-size: 0.8rem; text-align: center; margin-top: 20px;">
                    No dares yet this round.
                </div>
            </div>
            <div class="dare-input-group">
                <input type="text" id="dareInput" class="dare-input" placeholder="Enter a dare..." maxlength="60" disabled>
                <button id="btnSendDare" class="dare-send-btn" onclick="sendDare()" disabled>SEND</button>
            </div>
        </div>

    </div>

    <div class="bottom-bar">
        <button class="action-btn btn-secondary" onclick="openRoomModal()">ROOM</button>
        <button class="action-btn btn-secondary" onclick="copyInviteLink()">LINK</button>
        <button class="action-btn btn-primary" id="btnFlip" onclick="triggerFlip()">FLIP COIN</button>
        <button class="action-btn btn-danger" onclick="resetRoom()">RESET</button>
    </div>

    <div class="modal-backdrop" id="roomModal" onclick="closeRoomModal(event)">
        <div class="bottom-sheet" onclick="event.stopPropagation()">
            <h2 class="sheet-title">Manage Room</h2>
            <input type="text" id="modalRoomInput" class="sheet-input" placeholder="ENTER CODE" maxlength="6">
            <div class="sheet-grid">
                <button class="action-btn btn-primary" onclick="doCreateRoom()">CREATE NEW</button>
                <button class="action-btn btn-secondary" onclick="doJoinRoom()">JOIN</button>
                <button class="action-btn btn-secondary" onclick="doPasteCode()">PASTE</button>
                <button class="action-btn btn-secondary" onclick="copyInviteLink()">COPY LINK</button>
            </div>
            <div style="margin-top: 20px; text-align: center; color: var(--text-muted); font-size: 0.8rem;">
                Tap outside to close
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, runTransaction, serverTimestamp, onDisconnect, push, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAwlWUvMOBfz2pTh18MqpDsVk3Hl-xPmJQ",
            authDomain: "coinflip-97336.firebaseapp.com",
            databaseURL: "https://coinflip-97336-default-rtdb.firebaseio.com",
            projectId: "coinflip-97336",
            storageBucket: "coinflip-97336.firebasestorage.app",
            messagingSenderId: "1026597403544",
            appId: "1:1026597403544:web:f204ff9806ca73b7ecc9ed",
            measurementId: "G-D45WX8RGCW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- State ---
        let currentUser = null;
        let myNick = "Player";
        let currentRoomId = null;
        let currentFlipCount = 0;
        let lastResult = null;
        let currentCoinRotation = 0;
        let isFlippingAnim = false;

        // --- UI Refs ---
        const ui = {
            connStatus: document.getElementById('connStatus'),
            connText: document.getElementById('connText'),
            roomCode: document.getElementById('roomCodeDisplay'),
            myNick: document.getElementById('myNickDisplay'),
            playerList: document.getElementById('playerList'),
            coin: document.getElementById('coin'),
            resultText: document.getElementById('resultText'),
            flipOverlay: document.getElementById('flipOverlay'),
            roundNum: document.getElementById('roundNum'),
            btnHeads: document.getElementById('btnPredHeads'),
            btnTails: document.getElementById('btnPredTails'),
            myPredText: document.getElementById('myPrediction'),
            countHeads: document.getElementById('countHeads'),
            countTails: document.getElementById('countTails'),
            dareList: document.getElementById('dareList'),
            dareInput: document.getElementById('dareInput'),
            btnSendDare: document.getElementById('btnSendDare'),
            dareEligibility: document.getElementById('dareEligibility'),
            btnFlip: document.getElementById('btnFlip'),
            modal: document.getElementById('roomModal'),
            modalInput: document.getElementById('modalRoomInput')
        };

        // --- Init ---
        signInAnonymously(auth).catch(err => showToast("Auth failed: " + err.message, "error"));

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                
                const storedNick = localStorage.getItem('cf_nick');
                if (storedNick) {
                    myNick = storedNick;
                } else {
                    const array = new Uint8Array(3);
                    crypto.getRandomValues(array);
                    myNick = 'P' + Array.from(array).map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 5).toUpperCase();
                    localStorage.setItem('cf_nick', myNick);
                }
                ui.myNick.innerText = myNick;

                const connectedRef = ref(db, ".info/connected");
                onValue(connectedRef, (snap) => {
                    if (snap.val() === true) {
                        ui.connStatus.classList.add('connected');
                        ui.connText.innerText = "CONNECTED";
                    } else {
                        ui.connStatus.classList.remove('connected');
                        ui.connText.innerText = "OFFLINE";
                    }
                });

                // Auto-join from URL OR create new room automatically
                await handleAutoJoinOrCreation();
            }
        });

        // --- Invite & Auto-Room Logic ---
        function inviteLinkFor(roomId) {
            const url = new URL(window.location.href);
            url.searchParams.set("room", roomId);
            return url.toString();
        }

        async function handleAutoJoinOrCreation() {
            const url = new URL(window.location.href);
            let code = url.searchParams.get("room");
            code = code ? code.trim().toUpperCase() : "";

            if (!code) {
                // Generate new room code automatically
                const array = new Uint8Array(3);
                crypto.getRandomValues(array);
                code = Array.from(array).map(b => b.toString(16).padStart(2,'0')).join('').toUpperCase();

                // Update URL to reflect new room
                url.searchParams.set("room", code);
                window.history.replaceState({}, '', url);
                
                showToast("Created new room: " + code, "success");
            }

            if (ui.modalInput) ui.modalInput.value = code;
            await joinRoom(code);
        }

        window.copyInviteLink = function() {
            if (!currentRoomId) {
                showToast("Create/join a room first", "warn");
                return;
            }
            
            const link = inviteLinkFor(currentRoomId);
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(link)
                    .then(() => showToast("Link copied to clipboard", "success"))
                    .catch(e => fallbackCopy(link));
            } else {
                fallbackCopy(link);
            }
        };

        function fallbackCopy(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; 
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) showToast("Link copied (fallback)", "success");
                else showToast("Copy failed", "error");
            } catch (err) {
                showToast("Copy failed", "error");
            }
            document.body.removeChild(textArea);
        }

        // --- Room Management ---
        window.doCreateRoom = function() {
            const array = new Uint8Array(3);
            crypto.getRandomValues(array);
            const newCode = Array.from(array).map(b => b.toString(16).padStart(2,'0')).join('').toUpperCase();
            joinRoom(newCode);
            showToast("Room created: " + newCode, "success");
            closeRoomModal();
        };

        window.doJoinRoom = function() {
            const code = ui.modalInput.value.trim().toUpperCase();
            if (code.length < 3) return showToast("Invalid code", "error");
            joinRoom(code);
            closeRoomModal();
        };

        function joinRoom(code) {
            if (!currentUser) return;
            
            currentRoomId = code;
            ui.roomCode.innerText = code;
            
            const url = new URL(window.location);
            url.searchParams.set('room', code);
            window.history.replaceState({}, '', url);

            const userRef = ref(db, `rooms/${code}/players/${currentUser.uid}`);
            set(userRef, {
                nick: myNick,
                joinedAt: serverTimestamp(),
                online: true
            });
            onDisconnect(userRef).remove();

            startRoomListeners(code);
            
            if (!document.querySelector('.toast.success')) {
               showToast("Joined room " + code, "success");
            }
        }

        function startRoomListeners(roomId) {
            const roomRef = ref(db, `rooms/${roomId}`);

            onValue(ref(db, `rooms/${roomId}/players`), (snap) => {
                ui.playerList.innerHTML = '';
                const players = snap.val() || {};
                Object.values(players).forEach(p => {
                    const chip = document.createElement('div');
                    chip.className = 'player-chip online';
                    chip.textContent = p.nick;
                    ui.playerList.appendChild(chip);
                });
            });

            // FIXED: Flip Listener Logic
            onValue(ref(db, `rooms/${roomId}/flip`), (snap) => {
                const data = snap.val();
                
                // If no flip data exists (fresh room or reset)
                if (!data) {
                    lastResult = null;
                    ui.resultText.innerText = "WAITING...";
                    ui.resultText.classList.remove('glow');
                    return;
                }

                // If this is the first load of existing data -> Snap.
                // If the ID has changed since last known -> Animate.
                const isFirstLoad = (lastResult === null);
                const isNewFlip = (lastResult && lastResult.id !== data.id);

                if (isFirstLoad || isNewFlip) {
                    lastResult = { id: data.id, result: data.result, ts: data.ts };
                    // If first load, do NOT animate, just snap.
                    // If new flip, animate.
                    updateCoinVisuals(data.result, isNewFlip);
                }
            });

            onValue(ref(db, `rooms/${roomId}/flipCount`), (snap) => {
                currentFlipCount = snap.val() || 0;
                ui.roundNum.innerText = (currentFlipCount + 1);
                
                resetLocalRoundState(); 
                fetchPredictions();
            });

            setupDareListener(roomId);
        }

        // Helper to handle visual state
        function updateCoinVisuals(resultStr, animate) {
             const targetMod = (resultStr === "HEADS") ? 0 : 180;
             
             if (animate) {
                 animateCoinFlip(resultStr);
             } else {
                 // Immediate snap (no animation)
                 currentCoinRotation = targetMod;
                 ui.coin.style.transition = "none";
                 ui.coin.style.transform = `rotateY(${targetMod}deg)`;
                 
                 // Force browser reflow to apply 'none' transition immediately
                 ui.coin.offsetHeight; 

                 ui.resultText.innerText = resultStr;
                 ui.resultText.classList.add('glow');
                 checkDareEligibility(resultStr);
             }
        }

        function setupDareListener(roomId) {
            const daresRef = ref(db, `rooms/${roomId}/dares`);
            onValue(daresRef, (snap) => {
                if (currentFlipCount === 0) {
                    ui.dareList.innerHTML = '<div style="color:var(--text-muted);text-align:center;margin-top:20px">No flips yet.</div>';
                    return;
                }
                const roundDares = snap.child(String(currentFlipCount)).val();
                renderDares(roundDares);
            });
        }

        function fetchPredictions() {
            if (!currentRoomId) return;
            const targetRound = currentFlipCount + 1;
            const predRef = ref(db, `rooms/${currentRoomId}/predictions/${targetRound}`);
            
            onValue(predRef, (snap) => {
                const preds = snap.val() || {};
                let h = 0, t = 0;
                let myPred = null;

                Object.entries(preds).forEach(([uid, val]) => {
                    if (val === 'HEADS') h++;
                    else if (val === 'TAILS') t++;
                    if (uid === currentUser.uid) myPred = val;
                });

                ui.countHeads.innerText = h;
                ui.countTails.innerText = t;
                
                ui.btnHeads.classList.toggle('selected', myPred === 'HEADS');
                ui.btnTails.classList.toggle('selected', myPred === 'TAILS');
                ui.myPredText.innerText = myPred || "NONE";
            });
        }

        window.setPrediction = function(val) {
            if (!currentUser || !currentRoomId) return showToast("Join a room first", "warn");
            if (isFlippingAnim) return showToast("Flipping in progress...", "warn");

            const targetRound = currentFlipCount + 1;
            const updates = {};
            updates[`rooms/${currentRoomId}/predictions/${targetRound}/${currentUser.uid}`] = val;
            
            update(ref(db), updates).catch(e => showToast("Error: " + e.message, "error"));
        };

        window.triggerFlip = function() {
            if (!currentUser || !currentRoomId) return showToast("Join a room first", "warn");
            if (isFlippingAnim) return;

            const lockRef = ref(db, `rooms/${currentRoomId}/flipLock`);
            
            runTransaction(lockRef, (lock) => {
                const now = Date.now();
                if (lock && lock.expiresAt > now && lock.by !== currentUser.uid) {
                    return;
                }
                return {
                    by: currentUser.uid,
                    at: now,
                    expiresAt: now + 5000 
                };
            }).then((result) => {
                if (result.committed) {
                    return performFlipLogic(); 
                } else {
                    showToast("Someone else is flipping!", "warn");
                }
            }).catch(err => {
                console.error("Flip error:", err);
                showToast("Flip Failed: " + (err.message || "Unknown"), "error");
            });
        };

        function performFlipLogic() {
            const array = new Uint8Array(1);
            let randomVal;
            do {
                crypto.getRandomValues(array);
                randomVal = array[0];
            } while (randomVal >= 254);

            const isHeads = (randomVal % 2) === 0;
            const resultStr = isHeads ? "HEADS" : "TAILS";
            const newCount = currentFlipCount + 1;
            const flipId = `${newCount}-${Date.now()}`;

            const updates = {};
            updates[`rooms/${currentRoomId}/flip`] = {
                id: flipId,
                result: resultStr,
                ts: serverTimestamp(),
                by: currentUser.uid
            };
            updates[`rooms/${currentRoomId}/flipCount`] = newCount;
            updates[`rooms/${currentRoomId}/flipLock`] = null;

            return update(ref(db), updates);
        }

        function animateCoinFlip(resultStr) {
            isFlippingAnim = true;
            ui.btnFlip.disabled = true;
            ui.flipOverlay.classList.add('visible');
            ui.resultText.innerText = "";
            ui.resultText.classList.remove('glow');
            playAudio('flip');
            triggerHaptic(25);

            const coin = ui.coin;
            // Ensure coin has size before animating
            coin.style.transition = "transform 3s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
            
            const targetMod = (resultStr === "HEADS") ? 0 : 180;
            const minSpins = 5;
            const currentMod = currentCoinRotation % 360;
            const distance = (minSpins * 360) + (targetMod - currentMod);
            
            currentCoinRotation += distance;
            const wobble = (Math.random() > 0.5 ? 10 : -10);
            
            coin.style.transform = `rotateY(${currentCoinRotation}deg) rotateX(${wobble}deg)`;

            setTimeout(() => {
                isFlippingAnim = false;
                ui.btnFlip.disabled = false;
                ui.flipOverlay.classList.remove('visible');
                
                coin.style.transition = "transform 0.5s ease-out";
                coin.style.transform = `rotateY(${currentCoinRotation}deg) rotateX(0deg)`;
                
                ui.resultText.innerText = resultStr;
                ui.resultText.classList.add('glow');
                playAudio('land');
                triggerHaptic([50, 50, 50]);
                
                checkDareEligibility(resultStr);

            }, 3000);
        }

        function resetLocalRoundState() {
            ui.dareInput.disabled = true;
            ui.btnSendDare.disabled = true;
            ui.dareEligibility.innerText = "Waiting for result...";
            ui.dareEligibility.className = "dare-status";
        }

        function checkDareEligibility(resultStr) {
            const roundJustFinished = currentFlipCount; 
            if (roundJustFinished === 0) return;

            const myId = currentUser.uid;
            
            get(ref(db, `rooms/${currentRoomId}/predictions/${roundJustFinished}/${myId}`)).then(snap => {
                const myPred = snap.val();
                
                if (myPred === resultStr) {
                    ui.dareInput.disabled = false;
                    ui.btnSendDare.disabled = false;
                    ui.dareEligibility.innerText = "You guessed RIGHT! Send a dare.";
                    ui.dareEligibility.classList.add('success');
                    showToast("You won! Send a dare!", "success");
                } else {
                    ui.dareInput.disabled = true;
                    ui.btnSendDare.disabled = true;
                    ui.dareEligibility.innerText = "Wrong guess. No dare for you.";
                    ui.dareEligibility.classList.remove('success');
                }
            });
        }

        window.sendDare = function() {
            const text = ui.dareInput.value.trim();
            if (!text) return;
            if (!currentUser || !currentRoomId) return;

            const roundId = currentFlipCount;
            const dareData = {
                nick: myNick,
                text: text,
                ts: serverTimestamp()
            };

            set(ref(db, `rooms/${currentRoomId}/dares/${roundId}/${currentUser.uid}`), dareData)
                .then(() => {
                    ui.dareInput.value = '';
                    showToast("Dare sent!", "success");
                })
                .catch(err => showToast("Error sending dare", "error"));
        };

        function renderDares(daresMap) {
            ui.dareList.innerHTML = '';
            if (!daresMap) {
                ui.dareList.innerHTML = '<div style="color:var(--text-muted);text-align:center;margin-top:20px">No dares sent for this round.</div>';
                return;
            }

            const list = Object.values(daresMap).sort((a,b) => (a.ts || 0) - (b.ts || 0));
            list.forEach(dare => {
                const div = document.createElement('div');
                div.className = 'dare-item';
                div.innerHTML = `
                    <div class="dare-meta">
                        <span>${dare.nick}</span>
                        <span>Round #${currentFlipCount}</span>
                    </div>
                    <div style="font-weight:500;">${esc(dare.text)}</div>
                `;
                ui.dareList.appendChild(div);
            });
            ui.dareList.scrollTop = ui.dareList.scrollHeight;
        }

        window.resetRoom = function() {
            if (!currentRoomId || !confirm("Reset room? This clears all scores and history.")) return;
            
            const updates = {};
            updates[`rooms/${currentRoomId}/flipCount`] = 0;
            updates[`rooms/${currentRoomId}/flip`] = null;
            updates[`rooms/${currentRoomId}/predictions`] = null;
            updates[`rooms/${currentRoomId}/dares`] = null;
            
            update(ref(db), updates);
            showToast("Room reset", "warn");
        };

        function esc(str) {
            return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        window.showToast = function(msg, type="neutral") {
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.innerText = msg;
            document.getElementById('toastContainer').appendChild(t);
            setTimeout(() => {
                t.style.animation = "fadeOut 0.3s forwards";
                setTimeout(() => t.remove(), 300);
            }, 3000);
        };

        window.openRoomModal = () => ui.modal.classList.add('open');
        window.closeRoomModal = () => ui.modal.classList.remove('open');
        window.doPasteCode = async () => {
            try {
                const text = await navigator.clipboard.readText();
                ui.modalInput.value = text;
                showToast("Pasted", "success");
            } catch(e) { showToast("Clipboard empty or blocked", "error"); }
        };

        function playAudio(type) {
            try {
                const Ctx = window.AudioContext || window.webkitAudioContext;
                if (!Ctx) return;
                const ctx = new Ctx();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.connect(gain);
                gain.connect(ctx.destination);

                if (type === 'flip') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(400, ctx.currentTime);
                    osc.frequency.linearRampToValueAtTime(800, ctx.currentTime + 0.1);
                    gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.1);
                } else if (type === 'land') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(150, ctx.currentTime);
                    gain.gain.setValueAtTime(0.2, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.2);
                }
            } catch (e) { }
        }

        function triggerHaptic(pattern) {
            if (navigator.vibrate) navigator.vibrate(pattern);
        }
    </script>
</body>
</html>
