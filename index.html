<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Coin Flip Dare</title>
    <meta name="theme-color" content="#121212">
    <meta name="description" content="Multiplayer Coin Flip with Dares">

    <style>
        /* --- Reset & Base --- */
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --surface-highlight: #2c2c2c;
            --primary-color: #bb86fc;
            --secondary-color: #03dac6;
            --error-color: #cf6679;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --radius-lg: 20px;
            --radius-md: 12px;
            --spacing-unit: 8px;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            --font-mono: "SF Mono", "Monaco", "Inconsolata", "Fira Mono", "Droid Sans Mono", "Source Code Pro", monospace;
            --coin-size: 160px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Screens --- */
        .screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }
        .screen.hidden { transform: translateX(100%); pointer-events: none; }
        .screen.active { transform: translateX(0); }

        /* --- Start Screen --- */
        #startScreen {
            background: var(--bg-color);
            z-index: 200;
            justify-content: center;
            align-items: center;
            padding: 30px;
        }
        .start-card {
            background: var(--surface-color);
            padding: 30px;
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .start-title {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .name-input {
            width: 100%;
            padding: 16px;
            background: var(--bg-color);
            border: 2px solid var(--surface-highlight);
            border-radius: var(--radius-md);
            color: white;
            font-size: 1.1rem;
            margin-bottom: 20px;
            text-align: center;
        }
        .name-input:focus { border-color: var(--primary-color); outline: none; }

        /* --- Game Layout --- */
        .app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: var(--spacing-unit);
            overflow-y: auto;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            padding-bottom: 140px;
        }

        /* --- Header --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 4px;
        }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 700; letter-spacing: 0.5px; }
        .status-pill {
            font-size: 0.75rem;
            font-weight: 700;
            background: var(--surface-color);
            padding: 4px 10px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: var(--error-color); }
        .status-pill.connected .status-dot { background-color: var(--secondary-color); }

        /* --- Panels --- */
        .panel {
            background: var(--surface-color);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        /* --- Info Panel --- */
        .info-grid {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            font-size: 0.9rem;
            align-items: center;
        }
        .code-wrapper { display: flex; align-items: center; gap: 10px; }
        .info-value { font-family: var(--font-mono); font-weight: 600; color: var(--secondary-color); font-size: 1.1rem;}
        
        .icon-btn {
            background: rgba(3, 218, 198, 0.15);
            border: 1px solid rgba(3, 218, 198, 0.3);
            color: var(--secondary-color);
            cursor: pointer;
            width: 36px; height: 36px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 8px;
            padding: 0;
        }
        
        .player-list {
            grid-column: span 2;
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .player-chip {
            background: var(--surface-highlight);
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            display: flex; align-items: center; gap: 6px;
            border: 1px solid transparent;
        }
        .player-chip.is-flipper {
            border-color: var(--primary-color);
            background: rgba(187, 134, 252, 0.1);
        }
        .player-chip .crown { color: var(--primary-color); font-size: 0.9em; }

        /* --- Coin Section --- */
        .coin-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 0;
            position: relative;
            min-height: 240px;
        }
        .coin-container {
            width: var(--coin-size);
            height: var(--coin-size);
            perspective: 1000px;
            margin-bottom: 20px;
        }
        .coin {
            width: 100%; height: 100%;
            position: relative;
            transform-style: preserve-3d;
        }
        .coin-face {
            position: absolute;
            width: 100%; height: 100%;
            backface-visibility: hidden;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; font-weight: bold;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5), 0 5px 15px rgba(0,0,0,0.4);
            background: radial-gradient(circle at 30% 30%, #ffd700, #b8860b);
            color: #4a3b00;
            border: 4px solid #DAA520;
        }
        .coin-face.tails { transform: rotateY(180deg); background: radial-gradient(circle at 30% 30%, #c0c0c0, #808080); color: #333; border-color: #A9A9A9; }

        .result-display {
            font-size: 22px; font-weight: 800; letter-spacing: 2px;
            min-height: 1.5em; text-align: center; color: var(--text-main);
        }
        .result-display.glow { color: var(--secondary-color); text-shadow: 0 0 10px var(--secondary-color); }
        .turn-indicator { font-size: 0.9rem; color: var(--text-muted); margin-top: 5px; min-height: 1.2em;}
        .turn-indicator.your-turn { color: var(--primary-color); font-weight: bold; }

        /* --- Predictions --- */
        .prediction-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        .pred-btn {
            background: var(--surface-highlight);
            border: 2px solid transparent;
            color: var(--text-main);
            padding: 16px;
            border-radius: var(--radius-md);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        .pred-btn.selected {
            background: rgba(3, 218, 198, 0.15);
            border-color: var(--secondary-color);
            color: var(--secondary-color);
        }

        /* --- Dares --- */
        .dare-header { font-size: 0.9rem; font-weight: 600; margin-bottom: 8px; display: flex; justify-content: space-between; }
        .dare-status { font-size: 0.75rem; color: var(--text-muted); }
        .dare-status.success { color: var(--secondary-color); }
        .dare-input-group { display: flex; gap: 8px; }
        .dare-input {
            flex: 1; background: var(--bg-color); border: 1px solid var(--surface-highlight);
            border-radius: 8px; padding: 12px; color: white;
        }
        .dare-send-btn {
            background: var(--secondary-color); color: #000; border: none;
            border-radius: 8px; padding: 0 20px; font-weight: 700; cursor: pointer;
        }
        .dare-send-btn:disabled { background: var(--surface-highlight); color: var(--text-muted); opacity: 0.5; }

        /* --- Bottom Bar --- */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--surface-color); padding: 12px;
            display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: auto auto;
            gap: 10px; box-shadow: 0 -4px 10px rgba(0,0,0,0.3); z-index: 100;
            max-width: 600px; margin: 0 auto;
        }
        .action-btn {
            height: 52px; border: none; border-radius: var(--radius-md);
            font-weight: 700; font-size: 1rem; cursor: pointer;
        }
        .action-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-primary { background: var(--primary-color); color: #000; }
        .btn-secondary { background: var(--surface-highlight); color: var(--text-main); }
        .btn-danger { background: rgba(207, 102, 121, 0.2); color: var(--error-color); }

        /* --- Active Dare Overlay --- */
        #activeDareOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 40px; text-align: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #activeDareOverlay.visible { opacity: 1; pointer-events: auto; }
        .overlay-title { color: var(--error-color); font-size: 1.5rem; font-weight: 900; margin-bottom: 20px; letter-spacing: 3px; }
        .overlay-text { color: white; font-size: 2rem; font-weight: 700; margin-bottom: 40px; line-height: 1.4; }
        .overlay-btn {
            background: white; color: black; border: none;
            padding: 16px 32px; font-size: 1.2rem; font-weight: 800;
            border-radius: 50px; cursor: pointer; transform: scale(1);
            animation: pulse 2s infinite;
        }

        /* --- Toasts --- */
        .toast-container {
            position: fixed; top: 16px; left: 50%; transform: translateX(-50%);
            z-index: 300; display: flex; flex-direction: column; gap: 8px; width: 90%; max-width: 350px; pointer-events: none;
        }
        .toast {
            background: var(--surface-color); color: white; padding: 12px 16px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5); font-size: 0.9rem; text-align: center;
            border-left: 4px solid var(--text-muted); opacity: 0; animation: toastIn 0.3s forwards;
        }
        .toast.success { border-color: var(--secondary-color); }
        .toast.error { border-color: var(--error-color); }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes toastIn { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- START SCREEN -->
    <div id="startScreen" class="screen active">
        <div class="start-card">
            <div class="start-title">Coin Flip Dare</div>
            <input type="text" id="nameInput" class="name-input" placeholder="Enter Your Name" maxlength="12">
            <button class="action-btn btn-primary" onclick="enterGame()" style="width:100%">ENTER ROOM</button>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="gameScreen" class="screen hidden">
        <header style="max-width: 600px; margin: 0 auto; width: 100%; padding: 12px 16px;">
            <h1>Coin Flip Dare</h1>
            <div id="connStatus" class="status-pill">
                <div class="status-dot"></div>
                <span id="connText">OFFLINE</span>
            </div>
        </header>

        <div class="app-container">
            <!-- Info Panel -->
            <div class="panel">
                <div class="info-grid">
                    <div class="code-wrapper">
                        <span class="info-label">CODE:</span>
                        <span id="roomCodeDisplay" class="info-value">----</span>
                        <button class="icon-btn" onclick="copyInviteLink()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                        </button>
                    </div>
                    <div class="info-value" id="myNickDisplay">...</div>
                </div>
                <div class="player-list" id="playerList"></div>
            </div>

            <!-- Coin Area -->
            <div class="coin-section">
                <div class="coin-container">
                    <div class="coin" id="coin">
                        <div class="coin-face">H</div>
                        <div class="coin-face tails">T</div>
                    </div>
                </div>
                <div id="resultText" class="result-display">WAITING...</div>
                <div id="turnIndicator" class="turn-indicator">Waiting for game data...</div>
            </div>

            <!-- Predictions -->
            <div class="panel">
                <div class="dare-header"><span>PREDICTION</span></div>
                <div class="prediction-buttons">
                    <button class="pred-btn" id="btnPredHeads" onclick="setPrediction('HEADS')">HEADS</button>
                    <button class="pred-btn" id="btnPredTails" onclick="setPrediction('TAILS')">TAILS</button>
                </div>
            </div>

            <!-- Dares -->
            <div class="panel">
                <div class="dare-header">
                    <span>DARE CHAT</span>
                    <span id="dareEligibility" class="dare-status">Winners send dares</span>
                </div>
                <div class="dare-input-group">
                    <input type="text" id="dareInput" class="dare-input" placeholder="Enter dare..." disabled>
                    <button id="btnSendDare" class="dare-send-btn" onclick="sendDare()" disabled>SEND</button>
                </div>
            </div>
        </div>

        <div class="bottom-bar">
            <button class="action-btn btn-secondary" onclick="resetRoom()">RESET</button>
            <button class="action-btn btn-secondary" onclick="copyInviteLink()">LINK</button>
            <button class="action-btn btn-primary" id="btnFlip" onclick="triggerFlip()" disabled style="grid-column: span 2">FLIP COIN</button>
        </div>
    </div>

    <!-- Active Dare Overlay -->
    <div id="activeDareOverlay">
        <div class="overlay-title">ACTIVE DARE</div>
        <div class="overlay-text" id="overlayDareText">Loading...</div>
        <div style="font-size: 0.9rem; color: #ccc; margin-bottom: 20px;">From: <span id="overlaySender"></span></div>
        <button class="overlay-btn" onclick="completeDare()">COMPLETED</button>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, runTransaction, serverTimestamp, onDisconnect, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAwlWUvMOBfz2pTh18MqpDsVk3Hl-xPmJQ",
            authDomain: "coinflip-97336.firebaseapp.com",
            databaseURL: "https://coinflip-97336-default-rtdb.firebaseio.com",
            projectId: "coinflip-97336",
            storageBucket: "coinflip-97336.firebasestorage.app",
            messagingSenderId: "1026597403544",
            appId: "1:1026597403544:web:f204ff9806ca73b7ecc9ed",
            measurementId: "G-D45WX8RGCW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- State ---
        let currentUser = null;
        let myName = "";
        let currentRoomId = null;
        let currentFlipCount = 0;
        let lastResult = null;
        let currentCoinRotation = 0;
        let isFlippingAnim = false;
        let myPrediction = null; // Track local prediction state
        let currentFlipperId = null; // Who's turn is it?

        // --- UI ---
        const ui = {
            start: document.getElementById('startScreen'),
            game: document.getElementById('gameScreen'),
            nameIn: document.getElementById('nameInput'),
            roomCode: document.getElementById('roomCodeDisplay'),
            myNick: document.getElementById('myNickDisplay'),
            playerList: document.getElementById('playerList'),
            coin: document.getElementById('coin'),
            resultText: document.getElementById('resultText'),
            turnIndicator: document.getElementById('turnIndicator'),
            btnHeads: document.getElementById('btnPredHeads'),
            btnTails: document.getElementById('btnPredTails'),
            dareInput: document.getElementById('dareInput'),
            btnSendDare: document.getElementById('btnSendDare'),
            dareElig: document.getElementById('dareEligibility'),
            btnFlip: document.getElementById('btnFlip'),
            overlay: document.getElementById('activeDareOverlay'),
            overlayText: document.getElementById('overlayDareText'),
            overlaySender: document.getElementById('overlaySender')
        };

        // --- Startup Flow ---
        
        // Restore name
        const savedName = localStorage.getItem('cf_name');
        if(savedName) ui.nameIn.value = savedName;

        window.enterGame = function() {
            const name = ui.nameIn.value.trim();
            if(name.length < 1) return showToast("Enter a name first", "error");
            
            myName = name;
            localStorage.setItem('cf_name', name);
            
            ui.start.classList.add('hidden');
            ui.game.classList.remove('hidden');
            ui.game.classList.add('active');
            
            initFirebase();
        };

        function initFirebase() {
            signInAnonymously(auth).catch(e => showToast(e.message, "error"));
            onAuthStateChanged(auth, async (user) => {
                if(user) {
                    currentUser = user;
                    ui.myNick.innerText = myName;
                    
                    // Connected status
                    onValue(ref(db, ".info/connected"), (snap) => {
                        const s = document.getElementById('connStatus');
                        const t = document.getElementById('connText');
                        if(snap.val()){ s.classList.add('connected'); t.innerText="CONNECTED"; }
                        else { s.classList.remove('connected'); t.innerText="OFFLINE"; }
                    });

                    // Room Logic
                    const url = new URL(window.location.href);
                    let code = url.searchParams.get("room");
                    
                    if(!code) {
                        const arr = new Uint8Array(3); crypto.getRandomValues(arr);
                        code = Array.from(arr).map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();
                        url.searchParams.set("room", code);
                        window.history.replaceState({}, '', url);
                    }
                    
                    joinRoom(code);
                }
            });
        }

        function joinRoom(code) {
            currentRoomId = code;
            ui.roomCode.innerText = code;
            
            const userRef = ref(db, `rooms/${code}/players/${currentUser.uid}`);
            set(userRef, { nick: myName, joinedAt: serverTimestamp(), online: true });
            onDisconnect(userRef).remove();

            // Setup Listeners
            setupRoomListeners(code);
        }

        function setupRoomListeners(rid) {
            // 1. Players & Turn Management
            onValue(ref(db, `rooms/${rid}/players`), (snap) => {
                const players = snap.val() || {};
                const playerArray = Object.entries(players).map(([uid, p]) => ({uid, ...p}));
                
                // Sort by join time to establish stable turn order
                playerArray.sort((a,b) => (a.joinedAt || 0) - (b.joinedAt || 0));
                
                // Render List
                ui.playerList.innerHTML = '';
                playerArray.forEach(p => {
                    const el = document.createElement('div');
                    el.className = 'player-chip';
                    if(p.uid === currentFlipperId) el.classList.add('is-flipper');
                    el.innerHTML = `${p.uid === currentFlipperId ? '<span class="crown">ðŸ‘‘</span>' : ''}${p.nick}`;
                    ui.playerList.appendChild(el);
                });

                // Determine who is the flipper based on flipCount
                if(playerArray.length > 0) {
                    const index = currentFlipCount % playerArray.length;
                    const flipper = playerArray[index];
                    currentFlipperId = flipper.uid;
                    
                    updateTurnUI(flipper.nick);
                }
            });

            // 2. Flip Logic
            onValue(ref(db, `rooms/${rid}/flip`), (snap) => {
                const data = snap.val();
                if(!data) {
                    lastResult = null;
                    ui.resultText.innerText = "WAITING...";
                    ui.resultText.classList.remove('glow');
                    return;
                }
                
                const isNew = (!lastResult || lastResult.id !== data.id);
                if(isNew) {
                    lastResult = data;
                    // If timestamp is fresh (<5s), animate. Else snap.
                    const fresh = (Date.now() - (data.ts || 0)) < 5000;
                    updateCoin(data.result, fresh);
                }
            });

            // 3. Count (Drives turns)
            onValue(ref(db, `rooms/${rid}/flipCount`), (snap) => {
                currentFlipCount = snap.val() || 0;
                // Triggers player list re-eval for turn
                // Reset local prediction for new round
                myPrediction = null;
                ui.btnHeads.classList.remove('selected');
                ui.btnTails.classList.remove('selected');
                
                // Refresh turn UI if we have players already
                // (Handled by player listener usually, but fails if players dont change)
                // Let's force a refresh logic
                get(ref(db, `rooms/${rid}/players`)).then(s => {
                   // This is redundant but ensures sync
                });
            });

            // 4. Active Dare Overlay
            onValue(ref(db, `rooms/${rid}/activeDare`), (snap) => {
                const dare = snap.val();
                if(dare) {
                    ui.overlayText.innerText = dare.text;
                    ui.overlaySender.innerText = dare.fromNick;
                    ui.overlay.classList.add('visible');
                } else {
                    ui.overlay.classList.remove('visible');
                }
            });
            
            // 5. Check Dare Eligibility (for input panel)
            // Just check previous round predictions
            // We do this inside flip completion
        }

        // --- Game Logic ---

        function updateTurnUI(flipperName) {
            const isMe = (currentFlipperId === currentUser.uid);
            
            if(isMe) {
                ui.turnIndicator.innerText = "IT'S YOUR TURN TO FLIP!";
                ui.turnIndicator.className = "turn-indicator your-turn";
                // Button enabled only if predicted
                checkFlipButtonState();
            } else {
                ui.turnIndicator.innerText = `Waiting for ${flipperName} to flip...`;
                ui.turnIndicator.className = "turn-indicator";
                ui.btnFlip.disabled = true;
                ui.btnFlip.innerText = `WAITING FOR ${flipperName.toUpperCase()}`;
            }
        }

        window.setPrediction = function(side) {
            if(!currentRoomId) return;
            if(isFlippingAnim) return;

            myPrediction = side;
            
            // Visuals
            ui.btnHeads.classList.toggle('selected', side === 'HEADS');
            ui.btnTails.classList.toggle('selected', side === 'TAILS');
            
            // Save to DB
            const round = currentFlipCount + 1;
            const updates = {};
            updates[`rooms/${currentRoomId}/predictions/${round}/${currentUser.uid}`] = side;
            update(ref(db), updates);

            checkFlipButtonState();
        };

        function checkFlipButtonState() {
            if(currentFlipperId === currentUser.uid) {
                if(myPrediction) {
                    ui.btnFlip.disabled = false;
                    ui.btnFlip.innerText = "FLIP COIN";
                } else {
                    ui.btnFlip.disabled = true;
                    ui.btnFlip.innerText = "SELECT HEADS/TAILS FIRST";
                }
            }
        }

        window.triggerFlip = function() {
            if(currentFlipperId !== currentUser.uid) return;
            if(!myPrediction) return showToast("Select Heads or Tails first!", "error");

            // Transaction to lock and flip
            const lockRef = ref(db, `rooms/${currentRoomId}/flipLock`);
            runTransaction(lockRef, (lock) => {
                const now = Date.now();
                if(lock && lock.expiresAt > now && lock.by !== currentUser.uid) return; // Abort
                return { by: currentUser.uid, expiresAt: now + 5000 };
            }).then(res => {
                if(res.committed) {
                    // Logic
                    const arr = new Uint8Array(1); crypto.getRandomValues(arr);
                    const isHeads = (arr[0] % 2 === 0);
                    const resStr = isHeads ? "HEADS" : "TAILS";
                    
                    const updates = {};
                    updates[`rooms/${currentRoomId}/flip`] = {
                        id: `${currentFlipCount+1}-${Date.now()}`,
                        result: resStr,
                        ts: serverTimestamp()
                    };
                    updates[`rooms/${currentRoomId}/flipCount`] = currentFlipCount + 1;
                    updates[`rooms/${currentRoomId}/flipLock`] = null;
                    
                    update(ref(db), updates);
                }
            });
        };

        function updateCoin(resStr, animate) {
            if(animate) {
                isFlippingAnim = true;
                ui.btnFlip.disabled = true;
                
                // Sound
                const ctx = new (window.AudioContext||window.webkitAudioContext)();
                const o = ctx.createOscillator(); const g = ctx.createGain();
                o.connect(g); g.connect(ctx.destination);
                o.frequency.exponentialRampToValueAtTime(800, ctx.currentTime+0.1);
                g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime+0.1);
                o.start(); o.stop(ctx.currentTime+0.1);

                // Spin
                ui.coin.style.transition = "transform 3s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
                const target = (resStr === "HEADS" ? 0 : 180);
                const spins = 5 * 360;
                const current = currentCoinRotation % 360;
                const dist = spins + (target - current);
                currentCoinRotation += dist;
                ui.coin.style.transform = `rotateY(${currentCoinRotation}deg)`;

                setTimeout(() => {
                    isFlippingAnim = false;
                    ui.coin.style.transition = "transform 0.5s";
                    ui.coin.style.transform = `rotateY(${currentCoinRotation}deg)`; // remove wobble if any
                    finishFlip(resStr);
                }, 3000);
            } else {
                // Instant
                const target = (resStr === "HEADS" ? 0 : 180);
                currentCoinRotation = target;
                ui.coin.style.transition = "none";
                ui.coin.style.transform = `rotateY(${target}deg)`;
                finishFlip(resStr);
            }
        }

        function finishFlip(resStr) {
            ui.resultText.innerText = resStr;
            ui.resultText.classList.add('glow');
            
            // Check Dare Eligibility (Did I predict correctly?)
            // We look at prediction for THIS completed round
            // Note: flipCount has already incremented in DB by now usually.
            // But we need to look at predictions/{flipCount}.
            // Wait, flipCount in DB is now N. The flip that just finished was N.
            // So we look at predictions/N.
            
            const round = currentFlipCount;
            get(ref(db, `rooms/${currentRoomId}/predictions/${round}/${currentUser.uid}`)).then(s => {
                const pred = s.val();
                if(pred === resStr) {
                    ui.dareInput.disabled = false;
                    ui.btnSendDare.disabled = false;
                    ui.dareInput.placeholder = "You won! Write a dare...";
                    ui.dareInput.focus();
                    ui.dareElig.innerText = "YOU WON! SEND A DARE";
                    ui.dareElig.className = "dare-status success";
                } else {
                    ui.dareInput.disabled = true;
                    ui.btnSendDare.disabled = true;
                    ui.dareInput.placeholder = "Only winners can dare";
                    ui.dareElig.innerText = "Only winners can dare";
                    ui.dareElig.className = "dare-status";
                }
            });
        }

        // --- Dares ---

        window.sendDare = function() {
            const txt = ui.dareInput.value.trim();
            if(!txt) return;
            
            // Set Active Dare
            set(ref(db, `rooms/${currentRoomId}/activeDare`), {
                text: txt,
                fromNick: myName,
                ts: serverTimestamp()
            });
            
            ui.dareInput.value = "";
        };

        window.completeDare = function() {
            // Remove Active Dare
            set(ref(db, `rooms/${currentRoomId}/activeDare`), null);
        };

        // --- Helpers ---
        window.copyInviteLink = function() {
            const url = new URL(window.location.href);
            url.searchParams.set("room", currentRoomId);
            const str = url.toString();
            
            if(navigator.clipboard) {
                navigator.clipboard.writeText(str).then(()=>showToast("Link Copied","success"));
            } else {
                // Fallback
                const el = document.createElement('textarea');
                el.value = str; document.body.appendChild(el);
                el.select(); document.execCommand('copy');
                document.body.removeChild(el);
                showToast("Link Copied","success");
            }
        };

        window.resetRoom = function() {
            if(confirm("Reset room?")) {
                const u = {};
                u[`rooms/${currentRoomId}/flip`] = null;
                u[`rooms/${currentRoomId}/flipCount`] = 0;
                u[`rooms/${currentRoomId}/predictions`] = null;
                u[`rooms/${currentRoomId}/activeDare`] = null;
                update(ref(db), u);
            }
        };

        window.showToast = function(msg, type) {
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            el.innerText = msg;
            document.getElementById('toastContainer').appendChild(el);
            setTimeout(()=>el.remove(), 3000);
        };
    </script>
</body>
</html>


